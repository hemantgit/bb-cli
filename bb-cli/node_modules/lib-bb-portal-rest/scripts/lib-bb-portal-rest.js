!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("jxon")):"function"==typeof define&&define.amd?define("scripts/lib-bb-portal-rest.js",["jxon"],e):"object"==typeof exports?exports["scripts/lib-bb-portal-rest.js"]=e(require("jxon")):t["scripts/lib-bb-portal-rest.js"]=e(t.jxon)}(this,function(t){return function(t){function e(n){if(r[n])return r[n].exports;var o=r[n]={exports:{},id:n,loaded:!1};return t[n].call(o.exports,o,o.exports,e),o.loaded=!0,o.exports}var r={};return e.m=t,e.c=r,e.p="",e(0)}([function(t,e,r){"use strict";function n(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e["default"]=t,e}function o(t){return t&&t.__esModule?t:{"default":t}}function i(t){this.config=t,this.config.log("Configuration",t)}function s(t){if(!{}.hasOwnProperty.call(t,"plugin"))throw new Error("Configuration object must define plugin property");var e=Object.assign({},f,t);return{}.hasOwnProperty.call(t.plugin,"response")||(e.plugin.response=l["default"]),t.verbose?{}.hasOwnProperty.call(t.plugin,"log")?e.log=t.plugin.log:e.log=console.log:e.log=function(){},new i(e)}Object.defineProperty(e,"__esModule",{value:!0}),e["default"]=s;var a=r(1),u=o(a),c=r(4),l=o(c),h=r(2),p=n(h),f={scheme:"http",host:"localhost",port:"7777",context:"portalserver",username:"admin",password:"admin",portal:null,outputJxon:!0,verbose:!1};Object.assign(i.prototype,{server:function(){return new u["default"]("server",this.config,["portals"])},portal:function(){var t=["portals",this.config.portal];return new u["default"]("portal",this.config,t)},catalog:function(t){var e=["catalog"];return t&&e.push(t),new u["default"]("server",this.config,e)},portalCatalog:function(t){var e=["portals",this.config.portal,"catalog"];return t&&e.push(t),new u["default"]("portal",this.config,e)},container:function(t){var e=["portals",this.config.portal,"containers"];return t&&e.push(t),new u["default"]("container",this.config,e)},widget:function(t){var e=["portals",this.config.portal,"widgets"];return t&&e.push(t),new u["default"]("widget",this.config,e)},page:function(t){var e=["portals",this.config.portal,"pages"];return t&&e.push(t),new u["default"]("page",this.config,e)},link:function(t){var e=["portals",this.config.portal,"links"];return t&&e.push(t),new u["default"]("link",this.config,e)},user:function(t,e,r){var n=["users"];return t&&n.push(t),e&&n.push("groups"),r&&n.push(r),new u["default"]("user",this.config,n)},group:function(t,e,r){var n=["groups"];return t&&n.push(t),e&&n.push("users"),r&&n.push(r),new u["default"]("group",this.config,n)},template:function(t){var e=["templates"];return t&&e.push(t),new u["default"]("template",this.config,e)},audit:function(t){return new u["default"]("audit",this.config,[t?"auditmeta":"auditevents"])},cache:function(t){var e=["caches",t];return new u["default"]("cache",this.config,e)},"import":function(){var t=["import","portal"];return new u["default"]("import",this.config,t)},importItem:function(t){var e=["import","package"];return t&&e.push(this.config.portal),new u["default"]("importItem",this.config,e)},"export":function(t){var e=void 0;return t?(e=["orchestrator","export","files",t],new u["default"]("export",this.config,e)):(e=["export","portal"],new u["default"]("export",this.config,e).query({portalName:this.config.portal,includeGroups:!0}))},exportItem:function(t,e){var r=["export","package"];return e&&r.push(this.config.portal),r.push(t),new u["default"]("exportItem",this.config,r)},auto:function(t,e){var r=p.getPayloadType(t),n=void 0,o=this;return"path"===r?this.config.plugin.get(t).then(function(t){return o.doAuto(p.stringToJs(t),e)}):("xml"===r&&(n=p.stringToJs(t)),o.doAuto(n||t,e))},doAuto:function(t,e){var r=Object.keys(t)[0],n=Object.keys(t[r])[0],o=t[r][n].contextItemName,i=["container","widget","page","link","template","user","group"],s=void 0,a=void 0;switch(r){case"catalog":"[BBHOST]"===o?(s="catalog",a="post"):(s="portalCatalog",a="post");break;case"portals":s="server",a="post";break;case"portal":s="server",a="put";break;default:var u="s"===r.charAt(r.length-1);if(u){if(r.substr(0,r.length-1)!==n)throw new Error(r+" must be plural of "+n);s=n,a="post"}else i.indexOf(r)!==-1?(s=r,a="put"):(s=r,a="post")}return e&&(a=e),this[s]()[a](t)}})},function(t,e,r){"use strict";function n(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e["default"]=t,e}function o(t,e){var r=Object.keys(e),n=t;return r.length&&(r.map(function(t){return encodeURIComponent(t)+"="+encodeURIComponent(e[t])}),n+="?"+r.join("&")),n}function i(t,e,r){this.command=t,this.config=Object.assign({},e),this.uri=r,this.qs={},this.headers={"Content-Type":"application/xml"}}Object.defineProperty(e,"__esModule",{value:!0}),e["default"]=i;var s=r(2),a=n(s),u=["globalModelCache","retrievedWidgetCache","widgetChromeStaticCache","serverSideClosureCache","urlLevelCache","contentTemplateCache","webCache","gModelCache","uuidFromExtendedItemNamesCache","springAclCacheRegion","springAclSidCacheRegion","contextNameToItemNameToUuidCache","widgetCache","uuidToContentReferencesCache","itemUuidToReferencingLinkUuidsCache","uuidToCacheKeysCache","versionBundleCache"];Object.assign(i.prototype,{rights:function(){return this.uri.push("rights"),this},tag:function(t,e){return this.uri.push("tags"),t&&this.uri.push(t),e&&(this.qs.type=e),this},query:function(t){return this.qs=t,this},file:function(t){return"import"===this.uri[0]&&(this.headers["Content-Type"]="multipart/form-data",this.headers.Connection="keep-alive","package"!==this.uri[1]&&(this.uri=["orchestrator","import","upload"])),this.targetFile=t,this},get:function(){return"portals"===this.uri[0]&&2===this.uri.length&&(this.uri[1]+=".xml"),"catalog"===this.uri[2]&&this.uri[3]&&(this.uri[3]+=".xml"),"rights"!==this.uri[4]&&("pages"===this.uri[2]&&this.uri[3]&&(this.uri[3]+=".xml"),"containers"===this.uri[2]&&this.uri[3]&&(this.uri[3]+=".xml"),"widgets"===this.uri[2]&&this.uri[3]&&(this.uri[3]+=".xml"),"links"===this.uri[2]&&this.uri[3]&&(this.uri[3]+=".xml")),this.method="GET",this.prepareRequest()},post:function(t){return this.method="POST","export"===this.uri[0]&&"package"!==this.uri[1]&&(this.uri=["orchestrator","export","exportrequests"]),this.prepareRequest(t)},put:function(t){return this.method="PUT",this.prepareRequest(t)},"delete":function(t){if(this.method="DELETE",t)switch(this.method="POST",this.command){case"server":this.uri=["delete","catalog"];break;case"portal":this.uri[2]="delete",this.uri[3]="catalog";break;case"link":this.uri[2]="delete",this.uri[3]="links"}return"cache"===this.command&&"all"===this.uri[1]?this.deleteAllCache(0):this.prepareRequest(t)},prepareRequest:function(t){var e=t?a.getPayloadType(t):"",r={url:o(this.getUri(),this.qs),method:this.method,query:this.qs,headers:this.headers,username:this.config.username,password:this.config.password,file:this.targetFile};this.targetFile&&("POST"===this.method?r.upload=r.url.indexOf("import/package")===-1?"file":"package":r.url.indexOf("/export/")>-1&&(r.download=!0));var n=this;switch(e){case"jxon":return r.body=a.jsToString(t),this.doRequest(r);case"path":return this.config.plugin.getRequestBody(t).then(function(t){return r.body=t,n.doRequest(r)});default:return r.body=t,this.doRequest(r)}},doRequest:function(t){var e=this;return this.config.plugin.request(t,this.config.log).then(function(r){return e.config.log("Response",r),e.config.plugin.response(e.config,t,r)})},deleteAllCache:function(t){var e=this;return this.uri[1]=u[t],this.prepareRequest().then(function(r){return t<u.length-1?e.deleteAllCache(t+1):r})["catch"](function(r){return 404===r.response.status&&t<u.length-1?e.deleteAllCache(t+1):r})},getUri:function(){var t=this.config;return"orchestrator"===this.uri[0]&&t.orchestrator&&(t=this.config.orchestrator),t.scheme+"://"+t.host+":"+t.port+"/"+t.context+"/"+this.uri.join("/")}})},function(t,e,r){"use strict";function n(t){return t&&t.__esModule?t:{"default":t}}function o(t){try{var e=c["default"].jsToString(t);if("<"!==e[0])throw new Error("Invalid parameter:");return e}catch(r){var n=new Error("jxon.jsToString error\n"+r.message+"\n"+JSON.stringify(t));throw n.error=r,n}}function i(t){try{if("string"!=typeof t)throw new TypeError("Invalid parameter:");if(!t.length)return{};l={};var e=void 0;if("undefined"!=typeof DOMParser){var r=c["default"].stringToXml(t),n=r.getElementsByTagName("parsererror");e=c["default"].xmlToJs(r),n.length>0&&(l.level="fatalError",l.msg=c["default"].xmlToJs(n[0]).div._)}else e=c["default"].stringToJs(t);if(l.level&&"warning"!==l.level)throw new Error(l.msg);return e}catch(o){var i=new Error("jxon.stringToJs error\n"+o.message+"\n"+JSON.stringify(t));throw i.error=o,i}}function s(t){if("object"===("undefined"==typeof t?"undefined":a(t)))return"jxon";if("string"!=typeof t||""===t)throw new Error("Wrong payload: "+t);return"<"===t.trim().charAt(0)?"xml":"path"}Object.defineProperty(e,"__esModule",{value:!0});var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t};e.jsToString=o,e.stringToJs=i,e.getPayloadType=s;var u=r(3),c=n(u),l=void 0;c["default"].config({parserErrorHandler:function(t,e){l.level=t,l.msg=e}})},function(e,r){e.exports=t},function(t,e,r){"use strict";function n(t){return t&&t.__esModule?t:{"default":t}}function o(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e["default"]=t,e}function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function s(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function a(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function u(t){var e=t["content-type"];return e?e.split(";")[0]:""}function c(t,e,r){var n=u(e),o=t.find(function(t){return r.indexOf(t.search)>-1&&t.contentType===n});return!!o&&o.callback(r)}function l(t,e,r){var n=void 0;if(r.status>=200&&r.status<300){if(n=c(d["default"],r.headers,r.body))throw new v(n,r,e,t);return"application/octet-stream"===u(r.headers)?e.file:t.outputJxon?p.stringToJs(r.body):r.body}if(r.status>=300&&r.status<400){var o=t.plugin.urlParse(r.headers.location);throw new v("CXPRedirect: "+o.query.errorMessage,r,e,t)}if(r.status>=400&&r.status<500)throw new v(r.status+" "+r.statusText,r,e,t);if(n=c(m["default"],r.headers,r.body))throw new v(n,r,e,t);throw new v(r.status+" "+r.statusText,r,e,t)}Object.defineProperty(e,"__esModule",{value:!0}),e["default"]=l;var h=r(2),p=o(h),f=r(5),d=n(f),g=r(6),m=n(g),v=function(t){function e(t,r,n,o){i(this,e);var a=s(this,Object.getPrototypeOf(e).call(this,t+" "+n.url));return a.response=r,a.request=n,a.config=o,Error.captureStackTrace(a,a.constructor.name),a}return a(e,t),e}(Error)},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=r(2);e["default"]=[{contentType:"text/html",search:'<form action="/portalserver/j_spring_security_check" method="POST"',callback:function(){return"HTML Error: Invalid Session"}},{contentType:"text/html",search:'class="bd-errorMsg"',callback:function(t){var e=(0,n.stringToJs)(t),r=e.html.body.div.div.p[1];return"HTML Error: "+r._}},{contentType:"application/xml",search:"<level>ERROR</level>",callback:function(t){var e=(0,n.stringToJs)(t),r=e["import"].message;return"HTML Error: "+r}}]},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=r(2);e["default"]=[{contentType:"text/html",search:"<title>Error 500 Server Error</title>",callback:function(t){var e=(0,n.stringToJs)(t),r=e.html.body.p._,o=e.html.body.pre.join("\n");return"Server Error: "+r+o}},{contentType:"application/xml",search:"<errorMessage><message>",callback:function(t){var e=(0,n.stringToJs)(t),r=e.errorMessage.message;return"Server Error: "+r}}]}])});
//# sourceMappingURL=lib-bb-portal-rest.js.map